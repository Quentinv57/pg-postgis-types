{"version":3,"sources":["../src/index.js"],"names":[],"mappings":"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","file":"index.js","sourcesContent":["import wkx from 'wkx';\nimport array from 'postgres-array';\nimport types from 'pg-custom-types';\n\nconst POSTGIS = 'postgis';\n\nconst TYPENAMES = [ 'geometry',\n                    'geometry_dump',\n                    'geography',\n                    'box2d',\n                    'box3d',\n                    '_geometry',\n                    '_geometry_dump',\n                    '_geography',\n                    '_box2d',\n                    '_box3d' ];\n\nlet GEOMETRY_OID = null;\nlet GEOMETRY_ARRAY_OID = null;\n\nlet GEOGRAPHY_OID = null;\nlet GEOGRAPHY_ARRAY_OID = null;\n\nlet parseGeometryHandler = function (value) {\n  return wkx.Geometry.parse(new Buffer(value, 'hex'));\n};\n\nfunction parseGeometry(value) {\n  return parseGeometryHandler(value);\n}\n\nfunction parseBox(value) {\n  value = value.substring(value.indexOf('(') + 1, value.indexOf(')'));\n\n  const pairs = value.split(',');\n  const coordinates = [];\n\n  for (let pair of pairs) {\n    coordinates.push(pair.split(' ').map(i => +i));\n  }\n\n  return coordinates;\n}\n\nfunction parsePostgisArray(parser) {\n  return types.allowNull((value) => {\n    return array.parse(value.replace(/:/g, ','), types.allowNull(parser));\n  });\n}\n\nconst parsers = {\n  geometry: types.allowNull(parseGeometry),\n  geography: types.allowNull(parseGeometry),\n  box2d: types.allowNull(parseBox),\n  box3d: types.allowNull(parseBox),\n  _geometry: parsePostgisArray(parseGeometry),\n  _geography: parsePostgisArray(parseGeometry),\n  _box2d: parsePostgisArray(parseBox),\n  _box3d: parsePostgisArray(parseBox)\n};\n\nfunction postgis(postgres, connection, callback) {\n  if (types.oids[POSTGIS] && types.oids[POSTGIS].geometry != null) {\n    return callback();\n  }\n\n  types(postgres, connection, POSTGIS, TYPENAMES, (err, res) => {\n    if (err) {\n      return callback(err);\n    }\n\n    for (let parser of Object.keys(parsers)) {\n      if (res[parser]) {\n        postgres.types.setTypeParser(+res[parser], parsers[parser]);\n      }\n    }\n\n    GEOMETRY_OID = res.geometry;\n    GEOMETRY_ARRAY_OID = res._geometry;\n    GEOGRAPHY_OID = res.geography;\n    GEOGRAPHY_ARRAY_OID = res._geography;\n\n    postgis.names = types.names[POSTGIS];\n    postgis.oids = types.oids[POSTGIS];\n\n    callback();\n  });\n}\n\npostgis.isGeometryType = function (oid) {\n  return oid === GEOMETRY_OID || oid === GEOGRAPHY_OID ||\n         oid === GEOMETRY_ARRAY_OID || oid === GEOGRAPHY_ARRAY_OID;\n};\n\npostgis.setGeometryParser = function (parser) {\n  parseGeometryHandler = parser;\n};\n\nconst POSTGIS_TYPES = [\n  'Unknown',\n  'Point',\n  'LineString',\n  'Polygon',\n  'MultiPoint',\n  'MultiLineString',\n  'MultiPolygon',\n  'GeometryCollection',\n  'CircularString',\n  'CompoundCurve',\n  'CurvePolygon',\n  'MultiCurve',\n  'MultiSurface',\n  'PolyhedralSurface',\n  'Triangle',\n  'Tin'\n];\n\npostgis.srid = function (mod) {\n  return (((mod) & 0x1FFFFF00) << 3) >> 11;\n};\n\npostgis.type = function (mod) {\n  return (mod & 0x000000FC) >> 2;\n};\n\npostgis.z = function (mod) {\n  return (mod & 0x00000002) >> 1;\n};\n\npostgis.m = function (mod) {\n  return mod & 0x00000001;\n};\n\npostgis.ndims = function (mod) {\n  return 2 + postgis.z(mod) + postgis.m(mod);\n};\n\npostgis.typename = function (mod) {\n  const {type, srid, z, m} = postgis.typeobj(mod);\n\n  if (mod < 0) {\n    return '';\n  }\n\n  let name = '';\n\n  if (!(type || srid || z | m)) {\n    return '';\n  }\n\n  name += '(';\n\n  if (type) {\n    name += POSTGIS_TYPES[type];\n  } else {\n    name += 'Geometry';\n  }\n\n  if (z) {\n    name += 'Z';\n  }\n\n  if (m) {\n    name += 'M';\n  }\n\n  if (srid > 0) {\n    name += ',' + srid;\n  }\n\n  name += ')';\n\n  return name;\n};\n\npostgis.typeobj = function (mod) {\n  return {\n    type: postgis.type(mod),\n    srid: postgis.srid(mod),\n    z: postgis.z(mod),\n    m: postgis.m(mod),\n    ndims: postgis.ndims(mod)\n  };\n};\n\npostgis.geometryTypes = POSTGIS_TYPES;\n\nexport default postgis;\n"]}